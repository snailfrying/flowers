# Flowers å…¨æ–‡ç¿»è¯‘ï¼ˆåŒè¯­å¯¹ç…§ï¼‰æŠ€æœ¯æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-23  
> **ä½œè€…**: Flowers æŠ€æœ¯å›¢é˜Ÿ  
> **çŠ¶æ€**: è®¾è®¡é˜¶æ®µ

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡](#ä¸€èƒŒæ™¯ä¸ç›®æ ‡)
- [äºŒã€æŠ€æœ¯è°ƒç ”](#äºŒæŠ€æœ¯è°ƒç ”)
- [ä¸‰ã€å½“å‰æ¶æ„åˆ†æ](#ä¸‰å½“å‰æ¶æ„åˆ†æ)
- [å››ã€æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡](#å››æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡)
- [äº”ã€æŠ€æœ¯å†…å®¹ä¿æŠ¤ç­–ç•¥ï¼ˆç¨‹åºå‘˜è§†è§’ï¼‰](#äº”æŠ€æœ¯å†…å®¹ä¿æŠ¤ç­–ç•¥ç¨‹åºå‘˜è§†è§’)
- [å…­ã€æç¤ºè¯ä¸å¤šè¯­è¨€é›†æˆ](#å…­æç¤ºè¯ä¸å¤šè¯­è¨€é›†æˆ)
- [ä¸ƒã€å®ç°ç»†èŠ‚](#ä¸ƒå®ç°ç»†èŠ‚)
- [å…«ã€å¼€å‘è®¡åˆ’](#å…«å¼€å‘è®¡åˆ’)
- [ä¹ã€é£é™©è¯„ä¼°ä¸æ³¨æ„äº‹é¡¹](#ä¹é£é™©è¯„ä¼°ä¸æ³¨æ„äº‹é¡¹)
- [åã€åç»­ä¼˜åŒ–æ–¹å‘](#ååç»­ä¼˜åŒ–æ–¹å‘)

---

## ä¸€ã€èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 ä¸šåŠ¡èƒŒæ™¯

å®ç°"å…¨æ–‡ç¿»è¯‘ï¼ˆåŒè¯­å¯¹ç…§ï¼‰"æ˜¯ç¿»è¯‘ç±»æ’ä»¶ä»"å·¥å…·"å‘"å¹³å°"è·ƒè¿çš„å…³é”®åŠŸèƒ½ã€‚ç›®å‰å¸‚é¢ä¸Šæœ€æˆåŠŸçš„æ ‡æ†æ˜¯ **æ²‰æµ¸å¼ç¿»è¯‘ (Immersive Translate)**ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡

- **éä¾µå…¥å¼ç¿»è¯‘**ï¼šä¸ç ´ååŸç½‘é¡µç»“æ„ï¼ŒåŒè¯­å¯¹ç…§æ˜¾ç¤º
- **æ™ºèƒ½æ®µè½è¯†åˆ«**ï¼šè¿‡æ»¤å¯¼èˆªæ ã€ä¾§è¾¹æ ã€ä»£ç å—ç­‰ï¼Œåªç¿»è¯‘æ­£æ–‡å†…å®¹
- **é«˜æ€§èƒ½æ‰¹å¤„ç†**ï¼šå°†å¤šä¸ªæ®µè½åˆå¹¶ä¸ºä¸€æ¬¡ API è¯·æ±‚ï¼Œæå‡é€Ÿåº¦å¹¶èŠ‚çœ Token
- **åŠ¨æ€å†…å®¹æ”¯æŒ**ï¼šç›‘å¬å•é¡µåº”ç”¨ï¼ˆSPAï¼‰çš„åŠ¨æ€åŠ è½½ï¼Œè‡ªåŠ¨ç¿»è¯‘æ–°å†…å®¹
- **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šæµå¼å›å¡«ã€ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç¿»è¯‘ã€åŠ è½½åŠ¨ç”»ç­‰

### 1.3 äº§å“å®šä½

- **å·®å¼‚åŒ–ä¼˜åŠ¿**ï¼šåŸºäº React + TypeScript + æ— åç«¯æ¶æ„ï¼Œæ³¨é‡éšç§å’Œç”¨æˆ·è‡ªå®šä¹‰ API
- **æ ¸å¿ƒç«äº‰åŠ›**ï¼šæ™ºèƒ½æ‰¹å¤„ç†ã€ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç¿»è¯‘ã€æµå¼å›å¡«ã€PDF/Epub æ”¯æŒ

---

## äºŒã€æŠ€æœ¯è°ƒç ”

### 2.1 ä¸šç•Œæ–¹æ¡ˆå¯¹æ¯”

#### 2.1.1 æ²‰æµ¸å¼ç¿»è¯‘ (Immersive Translate) - ä¸šç•Œå¤©èŠ±æ¿

**æ ¸å¿ƒé€»è¾‘**ï¼š

- **DOM æ³¨å…¥**ï¼šåœ¨åŸæ–‡èŠ‚ç‚¹åé¢æ’å…¥è‡ªå®šä¹‰ HTML æ ‡ç­¾ï¼ˆå¦‚ `<span>` æˆ– `<div>`ï¼‰ï¼Œè€Œä¸æ˜¯æ›¿æ¢åŸæ–‡
- **æŠ€æœ¯æ ˆ**ï¼šä¼ ç»Ÿ JavaScript ç›´æ¥æ“ä½œ DOM

**å…³é”®ç®—æ³•**ï¼š

1. **æ™ºèƒ½æ®µè½è¯†åˆ«**ï¼šä½¿ç”¨æƒé‡ç®—æ³•ï¼ˆç±»ä¼¼ Readabilityï¼‰åˆ¤æ–­å“ªäº›æ˜¯"æ­£æ–‡"
   - è¿‡æ»¤å¯¼èˆªæ ã€ä¾§è¾¹æ ã€ä»£ç å—
   - è¯„ä¼°æ–‡æœ¬èŠ‚ç‚¹çš„çˆ¶å…ƒç´ ç‰¹å¾ï¼ˆæ ‡ç­¾ç±»å‹ã€ç±»åã€é•¿åº¦ç­‰ï¼‰

2. **é¢‘ç‡é™åˆ¶ä¸åˆ†æ‰¹ï¼ˆBatchingï¼‰**ï¼š
   - åˆå¹¶å¤šä¸ªå°æ®µè½ä¸ºä¸€ä¸ª API è¯·æ±‚
   - é˜²æ­¢ API è°ƒç”¨è¿‡å¿«å’ŒèŠ‚çœ Token

3. **MutationObserver**ï¼š
   - ç›‘å¬ç½‘é¡µåŠ¨æ€åŠ è½½ï¼ˆå¦‚ä¸‹æ‹‰åˆ·æ–°ï¼‰
   - å®ç°è‡ªåŠ¨ç¿»è¯‘æ–°å‡ºç°çš„å†…å®¹

**ä¼˜åŠ¿**ï¼š

- åŒè¯­å¯¹ç…§ä½“éªŒæä½³
- å…¼å®¹æ€§å¼ºï¼Œæ”¯æŒå„ç§å¤æ‚ç½‘é¡µ

**åŠ£åŠ¿**ï¼š

- å¯èƒ½è¯¯ç¿»è¯‘åŠŸèƒ½æ€§æ–‡æœ¬
- å¯¹æåº¦åŠ¨æ€çš„ç½‘ç«™ï¼ˆå¦‚ React é‡æ¸²æŸ“ï¼‰å¯èƒ½å¤±æ•ˆ

#### 2.1.2 Google Translate / Edge å†…ç½®ç¿»è¯‘

**æ ¸å¿ƒé€»è¾‘**ï¼š

- **å…¨é¡µé¢æ›¿æ¢**ï¼šé€’å½’éå† DOM æ ‘ï¼Œç›´æ¥ä¿®æ”¹ `textContent`

**ç¼ºç‚¹**ï¼š

- ç ´ååŸæ–‡ï¼Œæ— æ³•åŒè¯­å¯¹ç…§
- å¯¹åŠ¨æ€ç½‘é¡µï¼ˆReact/Vueï¼‰æä¸å‹å¥½
- ç»å¸¸å¯¼è‡´é¡µé¢å´©æºƒæˆ–åŠŸèƒ½å¤±æ•ˆ

### 2.2 æŠ€æœ¯é€‰å‹æ€»ç»“

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **DOM æ³¨å…¥ï¼ˆæ²‰æµ¸å¼ï¼‰** | ä¸ç ´ååŸæ–‡ã€åŒè¯­å¯¹ç…§ã€ç”¨æˆ·ä½“éªŒå¥½ | å®ç°å¤æ‚ã€å¯èƒ½è¯¯ç¿» | **Flowers æ¨è** |
| **å…¨é¡µé¢æ›¿æ¢ï¼ˆGoogleï¼‰** | å®ç°ç®€å• | ç ´ååŸæ–‡ã€ç ´ååŠŸèƒ½ | ä¸æ¨è |
| **Shadow DOM éš”ç¦»** | æ ·å¼éš”ç¦» | å¤æ‚åº¦é«˜ã€å…¼å®¹æ€§å·® | ç‰¹æ®Šåœºæ™¯ |

#### 2.3 é€‰å‹ç»“è®º

é‡‡ç”¨ **"éä¾µå…¥å¼ DOM æ³¨å…¥ + æ™ºèƒ½æ‰¹å¤„ç†"** æ–¹æ¡ˆã€‚

---

## ä¸‰ã€å½“å‰æ¶æ„åˆ†æ

### 3.1 ç°æœ‰æŠ€æœ¯æ¶æ„

```mermaid
Flowers æ¶æ„
â”œâ”€â”€ Frontend (Chrome Extension)
â”‚   â”œâ”€â”€ Content Script (content-script.ts)
â”‚   â”‚   â”œâ”€â”€ SelectionPopover (é€‰æ–‡ç¿»è¯‘)
â”‚   â”‚   â”œâ”€â”€ Video Subtitle Translation (å­—å¹•ç¿»è¯‘)
â”‚   â”‚   â””â”€â”€ Full Page Translation (å…¨æ–‡ç¿»è¯‘) [NEW]
â”‚   â”œâ”€â”€ Background Service Worker
â”‚   â””â”€â”€ Side Panel (ä¾§è¾¹æ )
â”‚
â””â”€â”€ Backend (æ— åç«¯ï¼ŒService Worker è°ƒåº¦)
    â”œâ”€â”€ Agent Layer
    â”‚   â””â”€â”€ nodes/translate.ts (ç¿»è¯‘èŠ‚ç‚¹)
    â”œâ”€â”€ Services
    â”‚   â”œâ”€â”€ LLM Client (clientFactory.ts)
    â”‚   â””â”€â”€ Prompt Management
    â””â”€â”€ Storage (Chrome Storage API)
```

### 3.2 ç°æœ‰ç¿»è¯‘åŠŸèƒ½åˆ†æ

#### 3.2.1 é€‰æ–‡ç¿»è¯‘ (SelectionPopover)

**ä½ç½®**ï¼š`frontend/src/components/popover/SelectionPopover.tsx`

**æ ¸å¿ƒé€»è¾‘**ï¼š

1. ç”¨æˆ·é€‰ä¸­æ–‡æœ¬è§¦å‘ `selectionchange` äº‹ä»¶
2. Content Script æ˜¾ç¤º Popoverï¼Œè°ƒç”¨ `handleTranslate()`
3. é€šè¿‡ `chrome.runtime.sendMessage` å‘é€åˆ° Background
4. Background è°ƒç”¨ `translateNode()` â†’ LLM API
5. è¿”å›ç¿»è¯‘ç»“æœæ˜¾ç¤ºåœ¨ Popover ä¸­

**ç‰¹ç‚¹**ï¼š

- âœ… ç”¨æˆ·ä¸»åŠ¨è§¦å‘
- âœ… å°æ®µæ–‡æœ¬ç¿»è¯‘
- âŒ ä¸æ”¯æŒå…¨é¡µé¢ç¿»è¯‘
- âŒ æ¯æ¬¡åªç¿»è¯‘ä¸€ä¸ªç‰‡æ®µ

#### 3.2.2 å­—å¹•ç¿»è¯‘ (Video Subtitle Translation)

**ä½ç½®**ï¼š`frontend/src/content/video/SubtitleTranslator.ts`

**æ ¸å¿ƒé€»è¾‘**ï¼š

```typescript
// æ™ºèƒ½æ‰¹å¤„ç†
private queue: SubtitleCue[] = [];
private batchDelay = 400; // ç­‰å¾…å­—å¹•å®Œæ•´

async addSubtitle(cue: SubtitleCue) {
    // æ£€æµ‹æ˜¯å¦æ˜¯åŒä¸€å¥è¯çš„å»¶ç»­
    const isExtension = newText.startsWith(this.streamBuffer);
    if (isExtension) {
        this.streamBuffer = newText; // æ›´æ–°ç¼“å†²åŒº
        this.resetTimer(); // é‡ç½®è®¡æ—¶å™¨
    } else {
        this.triggerTranslation(this.streamBuffer); // ç¿»è¯‘ä¸Šä¸€å¥
        this.streamBuffer = newText; // å¼€å§‹æ–°å¥
    }
}

private async processBatch() {
    // åˆå¹¶å¤šä¸ªå­—å¹•æ–‡æœ¬
    const textToTranslate = texts.join('\n');
    const translatedBlock = await this.callTranslateApi(textToTranslate);
    // åˆ†å‰²ç»“æœå¹¶ç¼“å­˜
    const translations = translatedBlock.split('\n');
}
```

**ç‰¹ç‚¹**ï¼š

- âœ… **æ™ºèƒ½æ‰¹å¤„ç†**ï¼šåˆå¹¶è¿ç»­å­—å¹•
- âœ… **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤ç¿»è¯‘
- âœ… **æµå¼å¤„ç†**ï¼šé€å¥ç¿»è¯‘ï¼Œä¸ç­‰å¾…æ•´æ®µ
- âœ… **é”™è¯¯æ¢å¤**ï¼šExtension context invalidated æ£€æµ‹

**å¯å¤ç”¨æ€§**ï¼š

- âœ… æ‰¹å¤„ç†é€»è¾‘å¯ç§»æ¤åˆ°å…¨æ–‡ç¿»è¯‘
- âœ… ç¼“å­˜æœºåˆ¶å¯ç›´æ¥å¤ç”¨
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶æˆç†Ÿ

#### 3.2.3 ç¿»è¯‘èŠ‚ç‚¹ (translateNode)

**ä½ç½®**ï¼š`backend/src/agent/nodes/translate.ts`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

1. **æ¨¡å¼æ£€æµ‹**ï¼š
   - `mode: 'subtitle'` â†’ å­—å¹•ç¿»è¯‘æ¨¡å¼ï¼ˆç®€æ´ï¼‰
   - é»˜è®¤æ¨¡å¼ â†’ æ™®é€šç¿»è¯‘
   - è¯å…¸æ¨¡å¼ â†’ çŸ­è¯­ç¿»è¯‘ï¼ˆâ‰¤3è¯ï¼‰

2. **ç¼“å­˜æœºåˆ¶**ï¼š

   ```typescript
   const translateCache = new LRUCache<string, string>({
       maxSize: 100,
       ttl: 30 * 60 * 1000 // 30 åˆ†é’Ÿ
   });
   ```

3. **Prompt ç­–ç•¥**ï¼š
   - `translate_subtitle_system` / `translate_subtitle_user`
   - `translate_dict_system` / `translate_dict_user`
   - `translate_system` / `translate_user`

**å¯æ‰©å±•æ€§**ï¼š

- âœ… æ”¯æŒæ·»åŠ æ–°æ¨¡å¼ï¼š`mode: 'full-page'`
- âœ… ç¼“å­˜æœºåˆ¶å¯å¤„ç†å…¨æ–‡ç¿»è¯‘
- âœ… Prompt ä½“ç³»æ˜“æ‰©å±•

### 3.3 æ¶æ„ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **æ¨¡å—åŒ–è®¾è®¡** | Translate Node ç‹¬ç«‹ï¼Œæ˜“æ‰©å±• |
| **ç¼“å­˜æœºåˆ¶** | LRU Cache æˆç†Ÿï¼Œå¯ç›´æ¥å¤ç”¨ |
| **æ™ºèƒ½æ‰¹å¤„ç†** | å­—å¹•ç¿»è¯‘å·²éªŒè¯ï¼Œå¯ç§»æ¤ |
| **é”™è¯¯å¤„ç†** | Extension context æ£€æµ‹å®Œå–„ |
| **i18n æ”¯æŒ** | å¤šè¯­è¨€ Prompt è‡ªåŠ¨åˆ‡æ¢ |

### 3.4 æ¶æ„é™åˆ¶

| é™åˆ¶ | å½±å“ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **Service Worker ç”Ÿå‘½å‘¨æœŸçŸ­** | é•¿æ—¶é—´ç¿»è¯‘å¯èƒ½ä¸­æ–­ | åˆ†æ‰¹å¤„ç† + é˜Ÿåˆ—ç®¡ç† |
| **Content Script æ— æ³•æŒä¹…åŒ–** | é¡µé¢åˆ·æ–°åä¸¢å¤±çŠ¶æ€ | ä½¿ç”¨ Chrome Storage ä¿å­˜è¿›åº¦ |
| **DOM æ“ä½œå¤æ‚åº¦** | React é¡µé¢å¯èƒ½é‡æ–°æ¸²æŸ“ | MutationObserver ç›‘å¬ + æ ‡è®°æœºåˆ¶ |
| **API è°ƒç”¨é¢‘ç‡é™åˆ¶** | è¿‡å¤šè¯·æ±‚å¯èƒ½è¢«å° | æ‰¹å¤„ç† + èŠ‚æµ + é˜Ÿåˆ— |

---

## å››ã€æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 4.1 æ•´ä½“æ¶æ„

```mermaid
å…¨æ–‡ç¿»è¯‘æ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Content Script                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  FullPageTranslationManager                     â”‚    â”‚
â”‚  â”‚  - æ§åˆ¶ç¿»è¯‘æµç¨‹                                  â”‚    â”‚
â”‚  â”‚  - ç®¡ç†ç¿»è¯‘çŠ¶æ€                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                 â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  NodeSelector               â”‚  DOMInjector    â”‚      â”‚
â”‚  â”‚  - è¯†åˆ«å¯ç¿»è¯‘èŠ‚ç‚¹           â”‚  - æ³¨å…¥ç¿»è¯‘ç»“æœ â”‚      â”‚
â”‚  â”‚  - è¿‡æ»¤å¯¼èˆª/ä»£ç å—          â”‚  - æ ·å¼ç®¡ç†     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                 â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  BatchProcessor                               â”‚      â”‚
â”‚  â”‚  - åˆå¹¶æ®µè½è¯·æ±‚                               â”‚      â”‚
â”‚  â”‚  - é˜Ÿåˆ—ç®¡ç†                                   â”‚      â”‚
â”‚  â”‚  - èŠ‚æµæ§åˆ¶                                   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    chrome.runtime.sendMessage
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Service Worker                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  message-handler.ts                                      â”‚
â”‚  - æ¥æ”¶ 'translateFullPage' æ¶ˆæ¯                         â”‚
â”‚  - è°ƒç”¨ CoreAgent.translate()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Backend Layer                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CoreAgent                                               â”‚
â”‚  â””â”€â”€ translateNode (mode: 'full-page')                   â”‚
â”‚      - Prompt: translate_fullpage_system/user            â”‚
â”‚      - LRU Cache                                         â”‚
â”‚      - Batch handling                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 4.2.1 FullPageTranslationManager

**èŒè´£**ï¼š

- ç®¡ç†æ•´ä¸ªå…¨æ–‡ç¿»è¯‘æµç¨‹
- æ§åˆ¶å¼€å…³çŠ¶æ€
- åè°ƒå„å­æ¨¡å—

**æ¥å£**ï¼š

```typescript
class FullPageTranslationManager {
    private enabled: boolean = false;
    private observer: MutationObserver | null = null;
    
    constructor(private targetLang: string) {}
    
    // å¯åŠ¨å…¨æ–‡ç¿»è¯‘
    async start(): Promise<void>;
    
    // åœæ­¢å…¨æ–‡ç¿»è¯‘
    stop(): void;
    
    // åˆ‡æ¢ç¿»è¯‘çŠ¶æ€
    toggle(): void;
    
    // æ›´æ–°ç›®æ ‡è¯­è¨€
    setTargetLang(lang: string): void;
}
```

#### 4.2.2 NodeSelector

**èŒè´£**ï¼š

- è¯†åˆ«é¡µé¢ä¸­çš„å¯ç¿»è¯‘èŠ‚ç‚¹
- è¿‡æ»¤ä¸éœ€è¦ç¿»è¯‘çš„å…ƒç´ 
- è¿”å›å¾…ç¿»è¯‘æ–‡æœ¬èŠ‚ç‚¹åˆ—è¡¨

**ç®—æ³•**ï¼š

```typescript
interface TranslatableNode {
    element: HTMLElement;
    textNode: Text;
    text: string;
    id: string; // å”¯ä¸€æ ‡è¯†
    priority: number; // æƒé‡
}

class NodeSelector {
    // é€‰æ‹©å¯ç¿»è¯‘èŠ‚ç‚¹
    selectNodes(): TranslatableNode[] {
        const nodes: TranslatableNode[] = [];
        
        // 1. ä½¿ç”¨ Readability æˆ–è‡ªå®šä¹‰ç®—æ³•æ‰¾åˆ°ä¸»å†…å®¹åŒº
        const mainContent = this.findMainContent();
        
        // 2. éå†æ–‡æœ¬èŠ‚ç‚¹
        const walker = document.createTreeWalker(
            mainContent,
            NodeFilter.SHOW_TEXT,
            {
                acceptNode: (node) => {
                    return this.shouldTranslate(node) 
                        ? NodeFilter.FILTER_ACCEPT 
                        : NodeFilter.FILTER_REJECT;
                }
            }
        );
        
        let currentNode: Text | null;
        while (currentNode = walker.nextNode() as Text) {
            const text = currentNode.textContent?.trim();
            if (text && text.length >= 10) { // æœ€å°é•¿åº¦è¿‡æ»¤
                nodes.push({
                    element: currentNode.parentElement!,
                    textNode: currentNode,
                    text: text,
                    id: this.generateNodeId(currentNode),
                    priority: this.calculatePriority(currentNode)
                });
            }
        }
        
        return nodes.sort((a, b) => b.priority - a.priority);
    }
    
    // åˆ¤æ–­æ˜¯å¦åº”è¯¥ç¿»è¯‘
    private shouldTranslate(node: Node): boolean {
        const parent = node.parentElement;
        if (!parent) return false;
        
        const tag = parent.tagName.toLowerCase();
        
        // 1. åŸºç¡€é»‘åå•æ ‡ç­¾ (åŠŸèƒ½æ€§/ä¸å¯è§)
        const blacklist = [
            'script', 'style', 'svg', 'canvas', 'video', 'audio',
            'nav', 'header', 'footer', 'aside', 'noscript'
        ];
        if (blacklist.includes(tag)) return false;

        // 2. æŠ€æœ¯å†…å®¹ä¿æŠ¤ (ä»£ç /å…¬å¼/å›¾è¡¨)
        // è¿™äº›å†…å®¹é€šå¸¸ç”±ä¸“é—¨çš„æ¸²æŸ“å¼•æ“å¤„ç†ï¼Œç¿»è¯‘ä¼šç ´åå…¶ç»“æ„
        const techBlacklist = [
            'code', 'pre', 'kbd', 'samp', 'var', 'math'
        ];
        if (techBlacklist.includes(tag)) return false;

        // 3. ç‰¹å®šç±»åè¿‡æ»¤ (å¦‚ Mermaid, KaTeX, Highlight.js)
        const techClasses = [
            'mermaid', 'katex', 'highlight', 'hljs', 'syntax-highlight'
        ];
        
        // æ£€æŸ¥è‡ªèº«åŠç¥–å…ˆå…ƒç´ 
        let ancestor: HTMLElement | null = parent;
        for (let i = 0; i < 5 && ancestor; i++) {
            const className = ancestor.className || '';
            const id = ancestor.id || '';
            
            // æ£€æŸ¥é»‘åå•æ ‡ç­¾
            if (blacklist.includes(ancestor.tagName.toLowerCase())) return false;
            if (techBlacklist.includes(ancestor.tagName.toLowerCase())) return false;

            // æ£€æŸ¥æŠ€æœ¯ç±»å
            if (techClasses.some(cls => className.includes(cls))) return false;

            // æ£€æŸ¥å¯¼èˆª/ä¾§è¾¹æ ç‰¹å¾
            if (className.match(/nav|menu|sidebar|footer|header/) ||
                id.match(/nav|menu|sidebar|footer|header/)) {
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²è¢«ç¿»è¯‘æ ‡è®°
            if (ancestor.hasAttribute('data-flowers-ignore')) return false;

            ancestor = ancestor.parentElement;
        }
        
        return true;
    }
    
    // è®¡ç®—èŠ‚ç‚¹æƒé‡ï¼ˆç±»ä¼¼ Readabilityï¼‰
    private calculatePriority(node: Text): number {
        let score = 0;
        const parent = node.parentElement!;
        const tag = parent.tagName.toLowerCase();
        
        // æ ‡ç­¾æƒé‡
        const tagScores: Record<string, number> = {
            'p': 10,
            'div': 5,
            'article': 15,
            'main': 15,
            'h1': 8, 'h2': 7, 'h3': 6,
            'li': 4,
            'td': 3
        };
        
        score += tagScores[tag] || 0;
        
        // æ–‡æœ¬é•¿åº¦æƒé‡
        const text = node.textContent?.trim() || '';
        if (text.length > 100) score += 5;
        if (text.length > 300) score += 10;
        
        // ç¥–å…ˆèŠ‚ç‚¹æƒé‡
        let ancestor = parent;
        for (let i = 0; i < 3 && ancestor; i++) {
            const aTag = ancestor.tagName.toLowerCase();
            if (aTag === 'article' || aTag === 'main') score += 10;
            ancestor = ancestor.parentElement!;
        }
        
        return score;
    }
    
    // ç”Ÿæˆå”¯ä¸€ ID
    private generateNodeId(node: Text): string {
        const path = this.getNodePath(node);
        return `flowers-trans-${btoa(path).slice(0, 16)}`;
    }
    
    // è·å–èŠ‚ç‚¹è·¯å¾„
    private getNodePath(node: Node): string {
        const path: string[] = [];
        let current: Node | null = node;
        while (current && current !== document.body) {
            if (current.parentNode) {
                const siblings = Array.from(current.parentNode.childNodes);
                const index = siblings.indexOf(current);
                path.unshift(`${current.nodeName}[${index}]`);
            }
            current = current.parentNode;
        }
        return path.join('/');
    }
}
```

#### 4.2.3 BatchProcessor

**èŒè´£**ï¼š

- åˆå¹¶å¤šä¸ªæ®µè½ä¸ºä¸€æ¬¡ API è¯·æ±‚
- ç®¡ç†ç¿»è¯‘é˜Ÿåˆ—
- èŠ‚æµæ§åˆ¶

**å®ç°**ï¼ˆå¤ç”¨å­—å¹•ç¿»è¯‘é€»è¾‘ï¼‰ï¼š

```typescript
interface TranslationTask {
    node: TranslatableNode;
    resolve: (translation: string) => void;
    reject: (error: Error) => void;
}

class BatchProcessor {
    private queue: TranslationTask[] = [];
    private batchTimer: number | null = null;
    private cache = new Map<string, string>();
    
    constructor(
        private targetLang: string,
        private batchDelay = 500, // ç­‰å¾…æ—¶é•¿
        private maxBatchSize = 10 // æ¯æ‰¹æœ€å¤šæ®µè½æ•°
    ) {}
    
    // æ·»åŠ ç¿»è¯‘ä»»åŠ¡
    async addTask(node: TranslatableNode): Promise<string> {
        // æ£€æŸ¥ç¼“å­˜
        const cached = this.cache.get(node.text);
        if (cached) return cached;
        
        return new Promise<string>((resolve, reject) => {
            this.queue.push({ node, resolve, reject });
            
            // é‡ç½®æ‰¹å¤„ç†è®¡æ—¶å™¨
            if (this.batchTimer) clearTimeout(this.batchTimer);
            
            // å¦‚æœé˜Ÿåˆ—å¤ªé•¿ï¼Œç«‹å³å¤„ç†
            if (this.queue.length >= this.maxBatchSize) {
                this.processBatch();
            } else {
                this.batchTimer = window.setTimeout(() => {
                    this.processBatch();
                }, this.batchDelay);
            }
        });
    }
    
    // å¤„ç†æ‰¹æ¬¡
    private async processBatch() {
        if (this.queue.length === 0) return;
        
        const batch = this.queue.splice(0, this.maxBatchSize);
        const texts = batch.map(task => task.node.text);
        
        try {
            // è°ƒç”¨ APIï¼ˆå¤ç”¨å­—å¹•ç¿»è¯‘é€»è¾‘ï¼‰
            const translatedBlock = await this.callTranslateApi(texts);
            
            // åˆ†å‰²ç»“æœ
            const translations = translatedBlock.split('\n').map(t => t.trim());
            
            batch.forEach((task, index) => {
                const translation = translations[index] || translatedBlock;
                this.cache.set(task.node.text, translation);
                task.resolve(translation);
            });
        } catch (error) {
            console.error('[BatchProcessor] Translation failed:', error);
            batch.forEach(task => task.reject(error as Error));
        }
    }
    
    // è°ƒç”¨ç¿»è¯‘ API
    private callTranslateApi(texts: string[]): Promise<string> {
        return new Promise((resolve, reject) => {
            chrome.runtime.sendMessage({
                action: 'translateFullPage',
                texts: texts, // å‘é€æ•°ç»„
                targetLang: this.targetLang
            }, (response) => {
                if (chrome.runtime.lastError) {
                    reject(chrome.runtime.lastError);
                } else if (response?.ok) {
                    resolve(response.result);
                } else {
                    reject(new Error(response?.error || 'Unknown error'));
                }
            });
        });
    }
}
```

#### 4.2.4 DOMInjector

**èŒè´£**ï¼š

- åœ¨åŸæ–‡åæ³¨å…¥ç¿»è¯‘ç»“æœ
- ç®¡ç†ç¿»è¯‘æ ·å¼
- æ”¯æŒæ˜¾ç¤º/éšè—åˆ‡æ¢

**å®ç°**ï¼š

```typescript
class DOMInjector {
    private injectedNodes = new Map<string, HTMLElement>();
    
    // æ³¨å…¥ç¿»è¯‘
    inject(node: TranslatableNode, translation: string) {
        // æ£€æŸ¥æ˜¯å¦å·²æ³¨å…¥
        if (this.injectedNodes.has(node.id)) {
            this.updateTranslation(node.id, translation);
            return;
        }
        
        // åˆ›å»ºç¿»è¯‘å®¹å™¨
        const translationSpan = document.createElement('span');
        translationSpan.className = 'flowers-translation';
        translationSpan.setAttribute('data-flowers-id', node.id);
        translationSpan.textContent = translation;
        
        // æ’å…¥åˆ°åŸæ–‡å
        if (node.textNode.nextSibling) {
            node.element.insertBefore(
                translationSpan, 
                node.textNode.nextSibling
            );
        } else {
            node.element.appendChild(translationSpan);
        }
        
        this.injectedNodes.set(node.id, translationSpan);
    }
    
    // æ›´æ–°ç¿»è¯‘
    private updateTranslation(nodeId: string, translation: string) {
        const element = this.injectedNodes.get(nodeId);
        if (element) {
            element.textContent = translation;
        }
    }
    
    // ç§»é™¤æ‰€æœ‰ç¿»è¯‘
    removeAll() {
        this.injectedNodes.forEach(element => element.remove());
        this.injectedNodes.clear();
    }
    
    // åˆ‡æ¢æ˜¾ç¤º/éšè—
    toggle(visible: boolean) {
        this.injectedNodes.forEach(element => {
            element.style.display = visible ? 'block' : 'none';
        });
    }
    
    // æ³¨å…¥æ ·å¼
    static injectStyles() {
        if (document.getElementById('flowers-translation-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'flowers-translation-styles';
        style.textContent = `
            .flowers-translation {
                display: block;
                color: #666;
                font-size: 0.9em;
                margin-top: 4px;
                line-height: 1.5;
                padding: 4px 0;
                border-left: 3px solid #e0e0e0;
                padding-left: 8px;
                font-style: italic;
            }
            
            @media (prefers-color-scheme: dark) {
                .flowers-translation {
                    color: #aaa;
                    border-left-color: #444;
                }
            }
            
            .flowers-translation-loading {
                opacity: 0.5;
                filter: blur(2px);
            }
        `;
        document.head.appendChild(style);
    }
}
```

### 4.3 MutationObserver ç›‘å¬

**èŒè´£**ï¼šç›‘å¬åŠ¨æ€å†…å®¹åŠ è½½ï¼ˆSPAï¼‰

```typescript
class DynamicContentObserver {
    private observer: MutationObserver | null = null;
    
    constructor(
        private onNewContent: (nodes: TranslatableNode[]) => void
    ) {}
    
    start() {
        this.observer = new MutationObserver((mutations) => {
            const newNodes: Node[] = [];
            
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        newNodes.push(node);
                    }
                });
            });
            
            if (newNodes.length > 0) {
                // ä½¿ç”¨ throttle é¿å…é¢‘ç¹è§¦å‘
                this.handleNewNodes(newNodes);
            }
        });
        
        this.observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
    
    stop() {
        this.observer?.disconnect();
        this.observer = null;
    }
    
    private handleNewNodes = this.throttle((nodes: Node[]) => {
        const selector = new NodeSelector();
        const translatable = nodes.flatMap(node => {
            const container = node as HTMLElement;
            return selector.selectNodesInContainer(container);
        });
        
        if (translatable.length > 0) {
            this.onNewContent(translatable);
        }
    }, 1000);
    
    private throttle<T extends (...args: any[]) => void>(
        func: T, 
        wait: number
    ): T {
        let timeout: number | null = null;
        return ((...args: any[]) => {
            if (timeout) clearTimeout(timeout);
            timeout = window.setTimeout(() => func(...args), wait);
        }) as T;
    }
}
```

### 4.4 Backend æ‰©å±•

#### 4.4.1 æ–°å¢ Message Handler

**ä½ç½®**ï¼š`backend/src/services/message-handler.ts`

```typescript
// æ·»åŠ æ–°æ¶ˆæ¯ç±»å‹
case 'translateFullPage': {
    const { texts, targetLang } = message;
    
    // åˆå¹¶å¤šæ®µæ–‡æœ¬
    const combinedText = texts.join('\n---\n');
    
    const result = await coreAgent.translate({
        text: combinedText,
        targetLang: targetLang,
        mode: 'full-page', // æ–°æ¨¡å¼
        llmConfig: llmConfig
    });
    
    sendResponse({ ok: true, result });
    break;
}
```

#### 4.4.2 æ–°å¢ Prompt

**ä½ç½®**ï¼š`backend/src/services/prompts/`

```typescript
// translate_fullpage_system.ts
export const translate_fullpage_system = {
    en: `You are a professional translator. Translate the following text segments to {{targetLang}}.

Requirements:
1. Each segment is separated by "---"
2. Preserve the order and structure
3. Return translations separated by "---"
4. Keep the same number of segments as input
5. Maintain context across segments for consistency`,
    
    zh: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¿»è¯‘å®˜ã€‚è¯·å°†ä»¥ä¸‹æ–‡æœ¬ç‰‡æ®µç¿»è¯‘ä¸º{{targetLang}}ã€‚

è¦æ±‚ï¼š
1. æ¯ä¸ªç‰‡æ®µä¹‹é—´ç”¨"---"åˆ†éš”
2. ä¿æŒé¡ºåºå’Œç»“æ„
3. è¿”å›çš„ç¿»è¯‘ç”¨"---"åˆ†éš”
4. ä¿æŒä¸è¾“å…¥ç›¸åŒçš„ç‰‡æ®µæ•°é‡
5. è·¨ç‰‡æ®µä¿æŒä¸Šä¸‹æ–‡ä¸€è‡´æ€§`,
};

// translate_fullpage_user.ts
export const translate_fullpage_user = {
    en: `Translate to {{targetLang}}:\n\n{{text}}`,
    zh: `ç¿»è¯‘ä¸º{{targetLang}}ï¼š\n\n{{text}}`
};
```

---

## äº”ã€æŠ€æœ¯å†…å®¹ä¿æŠ¤ç­–ç•¥ï¼ˆç¨‹åºå‘˜è§†è§’ï¼‰

ä½œä¸ºç¨‹åºå‘˜ï¼Œæˆ‘ä»¬æ·±çŸ¥ä»£ç å—ã€å…¬å¼å’Œæ¶æ„å›¾çš„ç²¾ç¡®æ€§è‡³å…³é‡è¦ã€‚ç¿»è¯‘è¿™äº›å†…å®¹ä¸ä»…æ²¡æœ‰æ„ä¹‰ï¼Œè¿˜ä¼šå¯¼è‡´è¯­æ³•é”™è¯¯æˆ–æ¸²æŸ“å¤±è´¥ã€‚

### 5.1 æ ¸å¿ƒåŸåˆ™ï¼šä¸ç¿»è¯‘å³æ˜¯æœ€å¥½çš„ç¿»è¯‘

1. **DOM çº§éš”ç¦»**ï¼šåœ¨ `NodeSelector` é˜¶æ®µç›´æ¥è·³è¿‡ `<code>`ã€`<pre>`ã€`.mermaid` ç­‰èŠ‚ç‚¹ã€‚è¿™æ˜¯æœ€ç¨³å¥çš„æ–¹æ³•ï¼Œå› ä¸º LLM æ°¸è¿œä¸ä¼šçœ‹åˆ°è¿™äº›å†…å®¹ã€‚
2. **å ä½ç¬¦ä¿æŠ¤**ï¼šå¯¹äºæ··åˆåœ¨æ–‡æœ¬ä¸­çš„æŠ€æœ¯æœ¯è¯­ï¼ˆå¦‚ `inline code`ï¼‰ï¼Œå¦‚æœ LLM ç¿»è¯‘äº†å®ƒä»¬ï¼Œå¯èƒ½ä¼šå¯¼è‡´å«ä¹‰æ¨¡ç³Šã€‚
3. **Markdown æ•æ„Ÿæ€§**ï¼šå¦‚æœé¡µé¢å†…å®¹æœ¬èº«æ˜¯ Markdown æ¸²æŸ“çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¿æŠ¤ Markdown è¯­æ³•ç¬¦å·ï¼ˆå¦‚ `[link](url)`ã€`**bold**`ï¼‰ã€‚

### 5.2 å¤æ‚å—çš„å¤„ç†ï¼šå ä½ç¬¦æœºåˆ¶

å¯¹äºæŸäº›å¿…é¡»ä¿æŒç»“æ„å®Œæ•´çš„å—ï¼Œæˆ‘ä»¬é‡‡ç”¨â€œæå–-å ä½-å›å¡«â€ç­–ç•¥ï¼š

```typescript
class TechContentProtector {
    private placeholders = new Map<string, string>();
    private counter = 0;

    // ä¿æŠ¤æŠ€æœ¯å†…å®¹
    protect(text: string): string {
        // ä¿æŠ¤è¡Œå†…ä»£ç  `code`
        return text.replace(/`([^`]+)`/g, (match) => {
            const id = `__FLOWERS_TECH_${this.counter++}__`;
            this.placeholders.set(id, match);
            return id;
        });
    }

    // æ¢å¤æŠ€æœ¯å†…å®¹
    restore(translatedText: string): string {
        let result = translatedText;
        this.placeholders.forEach((original, id) => {
            result = result.replace(id, original);
        });
        return result;
    }
}
```

### 5.3 æ¶æ„å›¾ä¸æµç¨‹å›¾ (Mermaid/SVG)

- **Mermaid**: è¯†åˆ« `.mermaid` ç±»åï¼Œç›´æ¥è·³è¿‡ã€‚
- **SVG**: è¯†åˆ« `<svg>` æ ‡ç­¾ï¼Œç›´æ¥è·³è¿‡ã€‚
- **Canvas**: è¯†åˆ« `<canvas>` æ ‡ç­¾ï¼Œç›´æ¥è·³è¿‡ã€‚

---

## å…­ã€æç¤ºè¯ä¸å¤šè¯­è¨€é›†æˆ

Flowers å·²ç»æ‹¥æœ‰ä¸€å¥—å®Œå–„çš„æç¤ºè¯ç®¡ç†å’Œä¸­è‹±ç®¡ç†ç³»ç»Ÿï¼Œå…¨æ–‡ç¿»è¯‘å¿…é¡»æ·±åº¦é›†æˆã€‚

### 6.1 æç¤ºè¯åŠ¨æ€æ¸²æŸ“

åˆ©ç”¨ç°æœ‰çš„ `getPrompt` å’Œ `render` å¼•æ“ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å…¨æ–‡ç¿»è¯‘çš„ Promptã€‚

```typescript
// backend/src/agent/nodes/translate.ts

const systemPrompt = getPrompt('translate_fullpage_system', lang, {
    targetLang: params.targetLang,
    context: pageContext,
    style: 'technical' // é»˜è®¤ä¸ºæŠ€æœ¯é£æ ¼
});
```

### 6.2 æœ¯è¯­è¡¨é›†æˆ (Glossary)

å¦‚æœç”¨æˆ·åœ¨è®¾ç½®ä¸­å®šä¹‰äº†æœ¯è¯­è¡¨ï¼ˆTerminologyï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç¿»è¯‘æ¯ä¸€æ‰¹æ¬¡æ—¶å°†å…¶æ³¨å…¥ã€‚

```typescript
// æ„é€  Prompt æ—¶æ³¨å…¥æœ¯è¯­
const userPrompt = getPrompt('translate_fullpage_user', lang, {
    text: combinedText,
    glossary: userGlossary.map(g => `${g.src} -> ${g.dst}`).join('\n')
});
```

### 6.3 è¯­è¨€æ„ŸçŸ¥ (Language Awareness)

- **è‡ªåŠ¨æ£€æµ‹æºè¯­è¨€**ï¼šå¦‚æœç”¨æˆ·æœªæŒ‡å®šï¼Œåˆ©ç”¨ LLM çš„è‡ªåŠ¨æ£€æµ‹èƒ½åŠ›ã€‚
- **ç›®æ ‡è¯­è¨€åŒæ­¥**ï¼šä» `i18n.language` æˆ–ç”¨æˆ·è®¾ç½®ä¸­å®æ—¶åŒæ­¥ã€‚

---

## ä¸ƒã€å®ç°ç»†èŠ‚

### 5.1 æ–‡ä»¶ç»“æ„

```text
frontend/src/content/
â”œâ”€â”€ fullpage/                          # æ–°å¢ç›®å½•
â”‚   â”œâ”€â”€ FullPageTranslationManager.ts  # ä¸»ç®¡ç†å™¨ï¼šè´Ÿè´£ç”Ÿå‘½å‘¨æœŸã€è®¾ç½®åŒæ­¥
â”‚   â”œâ”€â”€ NodeSelector.ts                # èŠ‚ç‚¹é€‰æ‹©å™¨ï¼šè´Ÿè´£è¯†åˆ«ã€è¿‡æ»¤ã€æƒé‡è®¡ç®—
â”‚   â”œâ”€â”€ BatchProcessor.ts              # æ‰¹å¤„ç†å™¨ï¼šè´Ÿè´£é˜Ÿåˆ—ã€é‡è¯•ã€æ¶ˆæ¯é€šä¿¡
â”‚   â”œâ”€â”€ DOMInjector.ts                 # DOM æ³¨å…¥å™¨ï¼šè´Ÿè´£æ ·å¼æ³¨å…¥ã€åŒè¯­å¯¹ç…§æ¸²æŸ“
â”‚   â”œâ”€â”€ DynamicContentObserver.ts      # åŠ¨æ€å†…å®¹ç›‘å¬ï¼šè´Ÿè´£ MutationObserver èŠ‚æµå¤„ç†
â”‚   â””â”€â”€ types.ts                       # ç±»å‹å®šä¹‰ï¼šå‰ç«¯å†…éƒ¨ç±»å‹
â”‚
â”œâ”€â”€ content-script.ts                  # ä¿®æ”¹ï¼šé›†æˆ FullPageTranslationManager
â””â”€â”€ content-script.css                 # ä¿®æ”¹ï¼šæ·»åŠ  .flowers-translated ç­‰æ ·å¼

backend/src/
â”œâ”€â”€ types.ts                           # ä¿®æ”¹ï¼šæ·»åŠ  mode: 'full-page' å’Œç›¸å…³ Params
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ message-handler.ts             # ä¿®æ”¹ï¼šæ·»åŠ  translateFullPage action
â”‚   â””â”€â”€ prompts/
â”‚       â”œâ”€â”€ translate_fullpage_system.ts  # æ–°å¢ï¼šç³»ç»Ÿæç¤ºè¯
â”‚       â””â”€â”€ translate_fullpage_user.ts    # æ–°å¢ï¼šç”¨æˆ·æç¤ºè¯ï¼ˆæ”¯æŒä¸Šä¸‹æ–‡å’Œæœ¯è¯­ï¼‰
â”‚
â””â”€â”€ agent/nodes/
    â””â”€â”€ translate.ts                   # ä¿®æ”¹ï¼šæ”¯æŒ mode: 'full-page'
```

#### 7.2.1 UI å…¥å£

```typescript
// frontend/src/components/settings/GeneralSettings.tsx
<div className="flex items-center justify-between">
    <Label>å…¨æ–‡ç¿»è¯‘ï¼ˆåŒè¯­å¯¹ç…§ï¼‰</Label>
    <Switch 
        checked={fullPageTranslationEnabled}
        onCheckedChange={handleToggleFullPageTranslation}
    />
</div>
```

#### 7.2.2 é¡µé¢å†…æµ®åŠ¨æŒ‰é’®

```typescript
// ç±»ä¼¼å­—å¹•ç¿»è¯‘çš„ Toggle Button
class FullPageToggleButton {
    private button: HTMLButtonElement | null = null;
    
    show() {
        this.button = document.createElement('button');
        this.button.className = 'flowers-fullpage-toggle';
        this.button.innerHTML = 'ğŸŒ ç¿»è¯‘';
        this.button.onclick = this.handleToggle;
        
        // å›ºå®šåœ¨å³ä¸‹è§’
        this.button.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2147483646;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        `;
        
        document.body.appendChild(this.button);
    }
}
```

**æ¨è**ï¼šåŒæ—¶æ”¯æŒä¸¤ç§æ–¹å¼ï¼Œè®¾ç½®ä¸­å¯é€‰æ‹©é»˜è®¤è¡Œä¸ºã€‚

#### 7.2.3 æ¶ˆæ¯é€šä¿¡è§„èŒƒ

éµå¾ªé¡¹ç›®ç°æœ‰çš„ `MessageRequest` å’Œ `Result` è§„èŒƒï¼š

```typescript
// backend/src/types.ts ä¿®æ”¹å»ºè®®
export interface TranslateParams {
  text: string;
  targetLang: string;
  sourceLang?: string;
  llmConfig?: LLMConfig;
  mode?: 'default' | 'subtitle' | 'full-page'; // æ–°å¢ full-page
  context?: string; // å…¨æ–‡ç¿»è¯‘ä¸Šä¸‹æ–‡ï¼ˆå¦‚é¡µé¢æ ‡é¢˜ã€æè¿°ï¼‰
  glossary?: string; // æœ¯è¯­è¡¨å­—ç¬¦ä¸²ï¼ˆç”±å‰ç«¯æ ¹æ®é¡µé¢å†…å®¹ç­›é€‰åä¼ å…¥ï¼‰
}

// å‰ç«¯å‘é€ç¿»è¯‘è¯·æ±‚ (BatchProcessor.ts)
chrome.runtime.sendMessage({
  action: 'translateFullPage',
  params: {
    text: texts.join('\n---\n'), // ä½¿ç”¨æ˜ç¡®çš„åˆ†éš”ç¬¦
    targetLang: 'zh',
    context: extractPageContext(),
    mode: 'full-page'
  }
}, (response: Result<string>) => {
  if (response.success && response.data) {
    const translations = response.data.split('\n---\n');
    // ç¡®ä¿è¿”å›æ•°é‡ä¸€è‡´
    if (translations.length === texts.length) {
      // æ­£å¸¸å›å¡«
    }
  }
});
```

#### 7.2.4 è®¾ç½®åŒæ­¥ä¸ç”Ÿå‘½å‘¨æœŸ

å¤ç”¨ `content-script.ts` çš„ `syncSettings` é€»è¾‘ï¼Œç¡®ä¿å…¨æ–‡ç¿»è¯‘å¼€å…³å®æ—¶ç”Ÿæ•ˆï¼š

```typescript
class FullPageTranslationManager {
    private isEnabled = false;

    constructor() {
        this.initSettingsListener();
    }

    private async initSettingsListener() {
        // åˆå§‹åŠ è½½
        const data = await chrome.storage.local.get('chroma-notes-settings');
        this.updateState(data['chroma-notes-settings']);

        // ç›‘å¬å˜åŒ–
        chrome.storage.onChanged.addListener((changes, area) => {
            if (area === 'local' && changes['chroma-notes-settings']) {
                this.updateState(changes['chroma-notes-settings'].newValue);
            }
        });
    }

    private updateState(rawSettings: any) {
        const settings = normalizeSettingsPayload(rawSettings);
        const shouldEnable = settings?.fullPageEnabled ?? false;
        
        if (shouldEnable && !this.isEnabled) {
            this.start();
        } else if (!shouldEnable && this.isEnabled) {
            this.stop();
        }
        this.isEnabled = shouldEnable;
    }
}
```

#### 5.2.2 ç¿»è¯‘æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"ç¿»è¯‘" 
    â†’ æ˜¾ç¤ºåŠ è½½æç¤º 
    â†’ NodeSelector è¯†åˆ«å¯ç¿»è¯‘èŠ‚ç‚¹ 
    â†’ åœ¨åŸæ–‡æ—æ˜¾ç¤º"ç¿»è¯‘ä¸­..."å ä½ç¬¦ 
    â†’ BatchProcessor åˆ†æ‰¹ç¿»è¯‘ 
    â†’ DOMInjector æµå¼æ³¨å…¥ç»“æœ 
    â†’ å®Œæˆæç¤º
```

### 5.3 æ€§èƒ½ä¼˜åŒ–

#### 5.3.1 æµå¼å›å¡«

**ç›®æ ‡**ï¼šç¬¬ä¸€ä¸ªæ®µè½ç¿»è¯‘å®Œç«‹å³æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯ç­‰æ‰€æœ‰æ®µè½

```typescript
class BatchProcessor {
    private async processBatch() {
        const batch = this.queue.splice(0, this.maxBatchSize);
        
        // æµå¼å¤„ç†
        for (let i = 0; i < batch.length; i += 5) { // æ¯ 5 ä¸ªä¸€ç»„
            const subBatch = batch.slice(i, i + 5);
            const texts = subBatch.map(task => task.node.text);
            
            const translatedBlock = await this.callTranslateApi(texts);
            const translations = translatedBlock.split('\n');
            
            // ç«‹å³å›å¡«è¿™ä¸€ç»„
            subBatch.forEach((task, index) => {
                const translation = translations[index] || translatedBlock;
                this.cache.set(task.node.text, translation);
                task.resolve(translation);
            });
        }
    }
}
```

#### 5.3.2 ä¸Šä¸‹æ–‡æ•æ„Ÿç¿»è¯‘

**ç—›ç‚¹**ï¼šé€å¥ç¿»è¯‘å®¹æ˜“ä¸¢å¤±ä¸Šä¸‹æ–‡

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ Prompt ä¸­æºå¸¦é¡µé¢æ ‡é¢˜å’Œå…³é”®è¯

```typescript
// æå–é¡µé¢ä¸Šä¸‹æ–‡
function extractPageContext(): string {
    const title = document.title || '';
    const h1 = document.querySelector('h1')?.textContent || '';
    const meta = document.querySelector('meta[name="description"]')
        ?.getAttribute('content') || '';
    
    return `æ ‡é¢˜: ${title}
ä¸»é¢˜: ${h1}
ç®€ä»‹: ${meta}`.trim();
}

// åœ¨ç¿»è¯‘æ—¶é™„åŠ ä¸Šä¸‹æ–‡
const prompt = `
ç½‘é¡µä¸Šä¸‹æ–‡ï¼š
${extractPageContext()}

è¯·ç¿»è¯‘ä»¥ä¸‹å†…å®¹ï¼Œä¿æŒæœ¯è¯­ä¸€è‡´æ€§ï¼š
${texts.join('\n---\n')}
`;
```

#### 5.3.3 æ™ºèƒ½é˜Ÿåˆ—ç®¡ç†

**ç›®æ ‡**ï¼šä¼˜å…ˆç¿»è¯‘ç”¨æˆ·å¯è§åŒºåŸŸ

```typescript
class BatchProcessor {
    private queue: TranslationTask[] = [];
    
    addTask(node: TranslatableNode): Promise<string> {
        // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦åœ¨è§†å£å†…
        const rect = node.element.getBoundingClientRect();
        const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
        
        const task = { node, resolve, reject, priority: isVisible ? 10 : 1 };
        
        // æŒ‰ä¼˜å…ˆçº§æ’å…¥é˜Ÿåˆ—
        const insertIndex = this.queue.findIndex(t => t.priority < task.priority);
        if (insertIndex === -1) {
            this.queue.push(task);
        } else {
            this.queue.splice(insertIndex, 0, task);
        }
        
        this.processBatch();
    }
}
```

### 5.4 é”™è¯¯å¤„ç†

#### 5.4.1 ç½‘ç»œé”™è¯¯

```typescript
class BatchProcessor {
    private retryCount = new Map<string, number>();
    private maxRetries = 3;
    
    private async processBatch() {
        try {
            // ... ç¿»è¯‘é€»è¾‘
        } catch (error) {
            console.error('[BatchProcessor] Translation failed:', error);
            
            // é‡è¯•æœºåˆ¶
            batch.forEach(task => {
                const count = this.retryCount.get(task.node.id) || 0;
                if (count < this.maxRetries) {
                    this.retryCount.set(task.node.id, count + 1);
                    this.queue.push(task); // é‡æ–°å…¥é˜Ÿ
                } else {
                    task.reject(new Error('ç¿»è¯‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'));
                }
            });
        }
    }
}
```

#### 5.4.2 Extension Context Invalidated

**å¤ç”¨å­—å¹•ç¿»è¯‘çš„æ£€æµ‹æœºåˆ¶**ï¼š

```typescript
private isContextInvalidated = false;

private callTranslateApi(texts: string[]): Promise<string> {
    if (this.isContextInvalidated) {
        return Promise.reject(new Error('Extension context invalidated'));
    }
    
    return new Promise((resolve, reject) => {
        try {
            chrome.runtime.sendMessage({ /* ... */ }, (response) => {
                if (chrome.runtime.lastError) {
                    const msg = chrome.runtime.lastError.message || '';
                    if (msg.includes('Extension context invalidated')) {
                        this.isContextInvalidated = true;
                        // æç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢
                        this.showRefreshPrompt();
                    }
                    reject(chrome.runtime.lastError);
                }
                // ...
            });
        } catch (e: any) {
            if (e.message?.includes('Extension context invalidated')) {
                this.isContextInvalidated = true;
            }
            reject(e);
        }
    });
}

private showRefreshPrompt() {
    const toast = document.createElement('div');
    toast.textContent = 'æ’ä»¶å·²æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢ä»¥ç»§ç»­ä½¿ç”¨ç¿»è¯‘åŠŸèƒ½';
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        padding: 16px; background: #ff6b6b; color: white;
        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}
```

---

## å…«ã€å¼€å‘è®¡åˆ’

### 6.1 åˆ†é˜¶æ®µå®ç°

#### é˜¶æ®µ 1ï¼šæ ¸å¿ƒåŠŸèƒ½ MVPï¼ˆé¢„è®¡ 3-4 å¤©ï¼‰

**ç›®æ ‡**ï¼šå®ç°åŸºç¡€çš„å…¨æ–‡ç¿»è¯‘åŠŸèƒ½

**ä»»åŠ¡æ¸…å•**ï¼š

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|--------|----------|--------|
| åˆ›å»º `fullpage/` ç›®å½•ç»“æ„ | å¼€å‘ | 0.5h | P0 |
| å®ç° `NodeSelector` åŸºç¡€ç‰ˆ | å¼€å‘ | 4h | P0 |
| å®ç° `BatchProcessor`ï¼ˆå¤ç”¨å­—å¹•é€»è¾‘ï¼‰ | å¼€å‘ | 3h | P0 |
| å®ç° `DOMInjector` åŸºç¡€ç‰ˆ | å¼€å‘ | 3h | P0 |
| å®ç° `FullPageTranslationManager` | å¼€å‘ | 4h | P0 |
| Backend: æ·»åŠ  `translateFullPage` handler | å¼€å‘ | 2h | P0 |
| Backend: æ–°å¢ `full-page` mode å’Œ Prompt | å¼€å‘ | 2h | P0 |
| UI: ä¾§è¾¹æ æ·»åŠ å…¨æ–‡ç¿»è¯‘å¼€å…³ | å¼€å‘ | 2h | P0 |
| æµ‹è¯•ï¼šç®€å•ç½‘é¡µï¼ˆå¦‚ Wikipediaï¼‰ | æµ‹è¯• | 2h | P0 |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… èƒ½å¤Ÿç¿»è¯‘ç®€å•é™æ€ç½‘é¡µï¼ˆå¦‚ Wikipedia æ–‡ç« ï¼‰
- âœ… åŒè¯­å¯¹ç…§æ˜¾ç¤ºæ­£å¸¸
- âœ… å¼€å…³åŠŸèƒ½æ­£å¸¸
- âœ… æ— æ˜æ˜¾æ€§èƒ½é—®é¢˜

#### é˜¶æ®µ 2ï¼šä¼˜åŒ–ä¸å¢å¼ºï¼ˆé¢„è®¡ 2-3 å¤©ï¼‰

**ç›®æ ‡**ï¼šæå‡ç¿»è¯‘è´¨é‡å’Œç”¨æˆ·ä½“éªŒ

**ä»»åŠ¡æ¸…å•**ï¼š

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|--------|----------|--------|
| ä¼˜åŒ– `NodeSelector` æƒé‡ç®—æ³• | å¼€å‘ | 4h | P1 |
| å®ç°æµå¼å›å¡« | å¼€å‘ | 3h | P1 |
| å®ç°ä¸Šä¸‹æ–‡æ•æ„Ÿç¿»è¯‘ | å¼€å‘ | 4h | P1 |
| æ·»åŠ åŠ è½½åŠ¨ç”»å’Œè¿›åº¦æç¤º | å¼€å‘ | 2h | P1 |
| å®ç°é”™è¯¯é‡è¯•æœºåˆ¶ | å¼€å‘ | 2h | P1 |
| ä¼˜åŒ–æ ·å¼ï¼ˆå“åº”å¼ã€æš—è‰²æ¨¡å¼ï¼‰ | å¼€å‘ | 2h | P1 |
| æµ‹è¯•ï¼šå¤æ‚ç½‘é¡µï¼ˆå¦‚æŠ€æœ¯åšå®¢ã€æ–°é—»ç½‘ç«™ï¼‰ | æµ‹è¯• | 4h | P1 |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… ç¿»è¯‘å‡†ç¡®ç‡é«˜ï¼Œæ— è¯¯ç¿»å¯¼èˆª/ä»£ç å—
- âœ… ç¿»è¯‘é€Ÿåº¦å¿«ï¼Œç”¨æˆ·ä½“éªŒæµç•…
- âœ… æ ·å¼ç¾è§‚ï¼Œé€‚é…æš—è‰²æ¨¡å¼
- âœ… é”™è¯¯å¤„ç†å®Œå–„

#### é˜¶æ®µ 3ï¼šåŠ¨æ€ç½‘é¡µæ”¯æŒï¼ˆé¢„è®¡ 2 å¤©ï¼‰

**ç›®æ ‡**ï¼šæ”¯æŒ SPA å’ŒåŠ¨æ€åŠ è½½å†…å®¹

**ä»»åŠ¡æ¸…å•**ï¼š

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|--------|----------|--------|
| å®ç° `DynamicContentObserver` | å¼€å‘ | 4h | P2 |
| é›†æˆåˆ° `FullPageTranslationManager` | å¼€å‘ | 2h | P2 |
| æ·»åŠ èŠ‚æµæ§åˆ¶ | å¼€å‘ | 2h | P2 |
| æµ‹è¯•ï¼šTwitter, Reddit ç­‰ SPA | æµ‹è¯• | 4h | P2 |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… è‡ªåŠ¨ç¿»è¯‘æ»šåŠ¨åŠ è½½çš„æ–°å†…å®¹
- âœ… ä¸å½±å“é¡µé¢æ€§èƒ½
- âœ… æ— é‡å¤ç¿»è¯‘

#### é˜¶æ®µ 4ï¼šé«˜çº§åŠŸèƒ½ï¼ˆé¢„è®¡ 3-4 å¤©ï¼‰

**ç›®æ ‡**ï¼šå·®å¼‚åŒ–åŠŸèƒ½

**ä»»åŠ¡æ¸…å•**ï¼š

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡å·¥æ—¶ | ä¼˜å…ˆçº§ |
|------|--------|----------|--------|
| PDF ç¿»è¯‘æ”¯æŒï¼ˆåŸºäº pdf.jsï¼‰ | å¼€å‘ | 8h | P3 |
| ç¿»è¯‘ç»“æœå¯¼å‡ºï¼ˆMarkdownï¼‰ | å¼€å‘ | 4h | P3 |
| ç¿»è¯‘å†å²è®°å½• | å¼€å‘ | 4h | P3 |
| è‡ªå®šä¹‰é»‘åå•ç½‘ç«™ | å¼€å‘ | 2h | P3 |

**éªŒæ”¶æ ‡å‡†**ï¼š

- âœ… å¯ä»¥ç¿»è¯‘åœ¨çº¿ PDF
- âœ… å¯¼å‡ºåŠŸèƒ½æ­£å¸¸
- âœ… å†å²è®°å½•å¯æŸ¥çœ‹å’Œç®¡ç†

### 6.2 æ€»ä½“æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | é¢„è®¡è€—æ—¶ | ç´¯è®¡è€—æ—¶ |
|------|----------|----------|
| é˜¶æ®µ 1: MVP | 3-4 å¤© | 3-4 å¤© |
| é˜¶æ®µ 2: ä¼˜åŒ– | 2-3 å¤© | 5-7 å¤© |
| é˜¶æ®µ 3: åŠ¨æ€ç½‘é¡µ | 2 å¤© | 7-9 å¤© |
| é˜¶æ®µ 4: é«˜çº§åŠŸèƒ½ | 3-4 å¤© | 10-13 å¤© |
| **æ€»è®¡** | **10-13 å¤©** | - |

**è¯´æ˜**ï¼š

- æŒ‰æ¯å¤© 6-8 å°æ—¶æœ‰æ•ˆå¼€å‘æ—¶é—´è®¡ç®—
- åŒ…å«å¼€å‘ã€æµ‹è¯•ã€è°ƒè¯•æ—¶é—´
- ä¸åŒ…å« Code Review å’Œæ–‡æ¡£ç¼–å†™æ—¶é—´

---

## ä¹ã€é£é™©è¯„ä¼°ä¸æ³¨æ„äº‹é¡¹

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| **React é¡µé¢é‡æ¸²æŸ“å¯¼è‡´æ³¨å…¥ä¸¢å¤±** | é«˜ | ä¸­ | ä½¿ç”¨ MutationObserver ç›‘å¬ï¼›å¢åŠ èŠ‚ç‚¹æ ‡è®°æœºåˆ¶ |
| **API è°ƒç”¨é¢‘ç‡è¿‡é«˜è¢«å°** | é«˜ | ä½ | æ‰¹å¤„ç† + ç¼“å­˜ï¼›é™åˆ¶æ¯åˆ†é’Ÿè¯·æ±‚æ•° |
| **Service Worker ç”Ÿå‘½å‘¨æœŸä¸­æ–­** | ä¸­ | ä¸­ | ä½¿ç”¨ Chrome Storage ä¿å­˜é˜Ÿåˆ—çŠ¶æ€ï¼›æ”¯æŒæ–­ç‚¹ç»­ä¼  |
| **å¤æ‚ç½‘é¡µç»“æ„è¯†åˆ«å¤±è´¥** | ä¸­ | é«˜ | æä¾›æ‰‹åŠ¨é€‰æ‹©åŒºåŸŸåŠŸèƒ½ï¼›æŒç»­ä¼˜åŒ–æƒé‡ç®—æ³• |
| **ç¿»è¯‘è´¨é‡ä¸ç¨³å®š** | ä¸­ | ä¸­ | ä¼˜åŒ– Promptï¼›å¢åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼›æ”¯æŒé‡æ–°ç¿»è¯‘ |

### 7.2 åŸºäºå½“å‰æ¶æ„çš„æ³¨æ„äº‹é¡¹

#### 7.2.1 Chrome Storage é™åˆ¶

**é—®é¢˜**ï¼šChrome Storage Local æœ‰å¤§å°é™åˆ¶ï¼ˆ5MBï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// åªç¼“å­˜å…³é”®æ•°æ®
class CacheManager {
    async saveCache() {
        const cache = Array.from(this.translationCache.entries())
            .slice(0, 100); // åªä¿å­˜æœ€è¿‘ 100 æ¡
        
        await chrome.storage.local.set({
            'flowers_translation_cache': cache
        });
    }
}
```

#### 7.2.2 Content Script èµ„æºæ¶ˆè€—

**é—®é¢˜**ï¼šå¤§é‡ DOM æ“ä½œå¯èƒ½å½±å“é¡µé¢æ€§èƒ½

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// ä½¿ç”¨ requestIdleCallback è¿›è¡Œéå…³é”®æ“ä½œ
class FullPageTranslationManager {
    private translateInIdle(nodes: TranslatableNode[]) {
        const processNode = (deadline: IdleDeadline) => {
            while (deadline.timeRemaining() > 0 && nodes.length > 0) {
                const node = nodes.shift()!;
                this.translateNode(node);
            }
            
            if (nodes.length > 0) {
                requestIdleCallback(processNode);
            }
        };
        
        requestIdleCallback(processNode);
    }
}
```

#### 7.2.3 ä¸ç°æœ‰é€‰æ–‡ç¿»è¯‘çš„å†²çª

**é—®é¢˜**ï¼šå…¨æ–‡ç¿»è¯‘å¼€å¯æ—¶ï¼Œç”¨æˆ·é€‰æ–‡å¯èƒ½è§¦å‘é‡å¤ç¿»è¯‘

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// åœ¨ content-script.ts ä¸­æ·»åŠ å†²çªæ£€æµ‹
let fullPageTranslationActive = false;

document.addEventListener('selectionchange', () => {
    if (fullPageTranslationActive) {
        // å…¨æ–‡ç¿»è¯‘æ¿€æ´»æ—¶ï¼Œç¦ç”¨é€‰æ–‡å¼¹çª—
        return;
    }
    // ... åŸæœ‰é€»è¾‘
});
```

#### 7.2.4 i18n æ”¯æŒ

**é—®é¢˜**ï¼šæ‰€æœ‰ UI æ–‡æœ¬å’Œ Prompt éœ€è¦æ”¯æŒå¤šè¯­è¨€

**è§£å†³æ–¹æ¡ˆ**ï¼š

```typescript
// frontend/src/shared/i18n/en.json
{
    "fullPageTranslation": {
        "title": "Full Page Translation",
        "enable": "Enable bilingual translation",
        "translating": "Translating...",
        "complete": "Translation complete",
        "error": "Translation failed, please try again",
        "refreshPrompt": "Extension updated, please refresh to continue"
    }
}

// frontend/src/shared/i18n/zh.json
{
    "fullPageTranslation": {
        "title": "å…¨æ–‡ç¿»è¯‘",
        "enable": "å¼€å¯åŒè¯­å¯¹ç…§",
        "translating": "ç¿»è¯‘ä¸­...",
        "complete": "ç¿»è¯‘å®Œæˆ",
        "error": "ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•",
        "refreshPrompt": "æ’ä»¶å·²æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢ä»¥ç»§ç»­ä½¿ç”¨"
    }
}
```

### 7.3 ç”¨æˆ·ä½“éªŒæ³¨æ„äº‹é¡¹

#### 7.3.1 é¦–æ¬¡ä½¿ç”¨å¼•å¯¼

**å®ç°**ï¼š

```typescript
class OnboardingGuide {
    async show() {
        const hasShown = await chrome.storage.local.get('fullpage_onboarding_shown');
        if (hasShown) return;
        
        // æ˜¾ç¤ºå¼•å¯¼å¼¹çª—
        const guide = document.createElement('div');
        guide.innerHTML = `
            <div class="flowers-onboarding">
                <h3>ğŸŒ¸ å…¨æ–‡ç¿»è¯‘åŠŸèƒ½å·²å¼€å¯</h3>
                <p>ç‚¹å‡»å³ä¸‹è§’çš„ç¿»è¯‘æŒ‰é’®å³å¯å¼€å§‹</p>
                <button onclick="this.parentElement.remove()">çŸ¥é“äº†</button>
            </div>
        `;
        document.body.appendChild(guide);
        
        await chrome.storage.local.set({ 'fullpage_onboarding_shown': true });
    }
}
```

#### 7.3.2 ç½‘ç«™å…¼å®¹æ€§é»‘åå•

**å®ç°**ï¼š

```typescript
class SiteBlacklist {
    private blacklist = [
        'mail.google.com',
        'outlook.office.com',
        'web.whatsapp.com'
    ];
    
    isBlacklisted(url: string): boolean {
        return this.blacklist.some(site => url.includes(site));
    }
    
    async addToBlacklist(url: string) {
        const custom = await chrome.storage.local.get('custom_blacklist');
        const list = custom['custom_blacklist'] || [];
        list.push(new URL(url).hostname);
        await chrome.storage.local.set({ 'custom_blacklist': list });
    }
}
```

---

## åã€åç»­ä¼˜åŒ–æ–¹å‘

### 8.1 ç”Ÿäº§åŠ›åŠŸèƒ½

#### 8.1.1 PDF ç¿»è¯‘

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨ `mozilla/pdf.js` è§£æ PDF
- æå–æ–‡æœ¬å†…å®¹è½¬ä¸º HTML
- åº”ç”¨å…¨æ–‡ç¿»è¯‘é€»è¾‘
- å¯¼å‡ºä¸ºåŒè¯­ PDF

**é¢„æœŸæ•ˆæœ**ï¼šæˆä¸ºç”Ÿäº§åŠ›å¸‚åœºçš„å·®å¼‚åŒ–åŠŸèƒ½

#### 8.1.2 Epub ç¿»è¯‘

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨ `futurepress/epub.js` è§£æ Epub
- ç¿»è¯‘æ¯ä¸ªç« èŠ‚
- å¯¼å‡ºä¸ºåŒè¯­ Epub

### 8.2 AI å¢å¼º

#### 8.2.1 ä¸“ä¸šæœ¯è¯­åº“

**å®ç°**ï¼š

```typescript
interface TerminologyEntry {
    source: string;
    target: string;
    category: 'tech' | 'medical' | 'legal' | 'general';
}

class TerminologyManager {
    private terms = new Map<string, TerminologyEntry>();
    
    async loadTerms() {
        // ä» Chrome Storage åŠ è½½
        const data = await chrome.storage.local.get('terminology_db');
        this.terms = new Map(data['terminology_db'] || []);
    }
    
    injectIntoPrompt(text: string): string {
        const relevantTerms = this.findRelevantTerms(text);
        if (relevantTerms.length === 0) return text;
        
        const glossary = relevantTerms
            .map(t => `- ${t.source} â†’ ${t.target}`)
            .join('\n');
        
        return `ç¿»è¯‘æ—¶è¯·å‚è€ƒä»¥ä¸‹æœ¯è¯­è¡¨ï¼š\n${glossary}\n\n${text}`;
    }
}
```

#### 8.2.2 ç¿»è¯‘è´¨é‡è¯„åˆ†

**å®ç°**ï¼š

```typescript
class QualityScorer {
    async score(original: string, translation: string): Promise<number> {
        // ä½¿ç”¨ LLM è¯„åˆ†
        const prompt = `
            è¯·è¯„ä¼°ä»¥ä¸‹ç¿»è¯‘è´¨é‡ï¼ˆ0-10åˆ†ï¼‰ï¼š
            åŸæ–‡ï¼š${original}
            è¯‘æ–‡ï¼š${translation}
            
            è¯„åˆ†æ ‡å‡†ï¼š
            - å‡†ç¡®æ€§ï¼ˆ4åˆ†ï¼‰
            - æµç•…æ€§ï¼ˆ3åˆ†ï¼‰
            - æœ¯è¯­ä¸€è‡´æ€§ï¼ˆ3åˆ†ï¼‰
        `;
        
        const response = await this.callLLM(prompt);
        return parseFloat(response);
    }
}
```

### 8.3 æ€§èƒ½ä¼˜åŒ–

#### 8.3.1 WebAssembly åŠ é€Ÿ

**åœºæ™¯**ï¼šèŠ‚ç‚¹é€‰æ‹©å’Œæ–‡æœ¬é¢„å¤„ç†

**å®ç°**ï¼š

```typescript
// ä½¿ç”¨ Rust + wasm-pack ç¼–è¯‘
import init, { select_nodes_wasm } from './pkg/flowers_wasm';

class NodeSelector {
    async selectNodesOptimized(): Promise<TranslatableNode[]> {
        await init();
        const html = document.body.innerHTML;
        const result = select_nodes_wasm(html);
        return JSON.parse(result);
    }
}
```

#### 8.3.2 æœ¬åœ°ç¼“å­˜æŒä¹…åŒ–

**å®ç°**ï¼š

```typescript
// ä½¿ç”¨ IndexedDB å­˜å‚¨å¤§é‡ç¿»è¯‘ç¼“å­˜
import Dexie from 'dexie';

class TranslationDB extends Dexie {
    translations!: Dexie.Table<{id: string, text: string, result: string}, string>;
    
    constructor() {
        super('FlowersTranslationDB');
        this.version(1).stores({
            translations: 'id, text, result'
        });
    }
}
```

---

## é™„å½• Aï¼šå®Œæ•´ç¤ºä¾‹ä»£ç 

### A.1 FullPageTranslationManagerï¼ˆå®Œæ•´ç‰ˆï¼‰

```typescript
import { NodeSelector } from './NodeSelector';
import { BatchProcessor } from './BatchProcessor';
import { DOMInjector } from './DOMInjector';
import { DynamicContentObserver } from './DynamicContentObserver';

export class FullPageTranslationManager {
    private enabled: boolean = false;
    private selector: NodeSelector;
    private processor: BatchProcessor;
    private injector: DOMInjector;
    private observer: DynamicContentObserver;
    
    constructor(private targetLang: string = 'zh') {
        this.selector = new NodeSelector();
        this.processor = new BatchProcessor(targetLang);
        this.injector = new DOMInjector();
        this.observer = new DynamicContentObserver(
            (nodes) => this.translateNodes(nodes)
        );
        
        // æ³¨å…¥æ ·å¼
        DOMInjector.injectStyles();
    }
    
    async start() {
        if (this.enabled) return;
        
        console.log('[FullPageTranslation] Starting...');
        this.enabled = true;
        
        // é€‰æ‹©èŠ‚ç‚¹
        const nodes = this.selector.selectNodes();
        console.log(`[FullPageTranslation] Found ${nodes.length} nodes`);
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        this.showToast('ç¿»è¯‘ä¸­...', 'info');
        
        // ç¿»è¯‘èŠ‚ç‚¹
        await this.translateNodes(nodes);
        
        // å¯åŠ¨åŠ¨æ€ç›‘å¬
        this.observer.start();
        
        this.showToast('ç¿»è¯‘å®Œæˆ', 'success');
    }
    
    stop() {
        if (!this.enabled) return;
        
        console.log('[FullPageTranslation] Stopping...');
        this.enabled = false;
        
        // ç§»é™¤æ‰€æœ‰ç¿»è¯‘
        this.injector.removeAll();
        
        // åœæ­¢ç›‘å¬
        this.observer.stop();
    }
    
    toggle() {
        if (this.enabled) {
            this.stop();
        } else {
            this.start();
        }
    }
    
    setTargetLang(lang: string) {
        this.targetLang = lang;
        this.processor = new BatchProcessor(lang);
    }
    
    private async translateNodes(nodes: TranslatableNode[]) {
        for (const node of nodes) {
            // æ·»åŠ å ä½ç¬¦
            this.injector.inject(node, 'ç¿»è¯‘ä¸­...');
            
            try {
                // æ‰¹é‡ç¿»è¯‘
                const translation = await this.processor.addTask(node);
                
                // æ›´æ–°ç¿»è¯‘
                this.injector.inject(node, translation);
            } catch (error) {
                console.error('[FullPageTranslation] Translation failed:', error);
                this.injector.inject(node, '[ç¿»è¯‘å¤±è´¥]');
            }
        }
    }
    
    private showToast(message: string, type: 'info' | 'success' | 'error') {
        const toast = document.createElement('div');
        toast.className = `flowers-toast flowers-toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2147483647;
            padding: 12px 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
}
```

---

## é™„å½• Bï¼šå‚è€ƒèµ„æ–™

### B.1 å¼€æºé¡¹ç›®

- **æ²‰æµ¸å¼ç¿»è¯‘**: [immersive-translate](https://github.com/immersive-translate/immersive-translate)
- **Mozilla Readability**: [mozilla/readability](https://github.com/mozilla/readability)
- **PDF.js**: [mozilla/pdf.js](https://github.com/mozilla/pdf.js)

### B.2 æŠ€æœ¯æ–‡æ¡£

- [Chrome Extension API - MutationObserver](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)
- [Chrome Extension API - Storage](https://developer.chrome.com/docs/extensions/reference/storage/)
- [Floating UI](https://floating-ui.com/)

### B.3 ç›¸å…³è®ºæ–‡

- [Context-Aware Machine Translation](https://arxiv.org/abs/1906.00789)
- [Neural Machine Translation with Extended Context](https://arxiv.org/abs/1810.05580)

---

## æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **æŠ€æœ¯å¯è¡Œæ€§é«˜**ï¼šåŸºäºç°æœ‰æ¶æ„å’Œå­—å¹•ç¿»è¯‘ç»éªŒï¼Œé£é™©å¯æ§
2. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šæµå¼å›å¡«ã€æ™ºèƒ½æ‰¹å¤„ç†ã€ä¸Šä¸‹æ–‡æ„ŸçŸ¥
3. **å¼€å‘å‘¨æœŸçŸ­**ï¼šæ ¸å¿ƒåŠŸèƒ½ MVP ä»…éœ€ 3-4 å¤©
4. **å¯æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒ PDFã€Epub ç­‰é«˜çº§åŠŸèƒ½

### å»ºè®®ç¬¬ä¸€æ­¥

**å…ˆåšä¸€ä¸ªç®€å•çš„"å…¨æ–‡ç¿»è¯‘"æŒ‰é’®**ï¼š

1. éå†é¡µé¢æ‰€æœ‰ `<p>` æ ‡ç­¾
2. åˆå¹¶è¯·æ±‚å‘ç»™ LLM
3. æ’å›é¡µé¢ï¼ˆåŒè¯­å¯¹ç…§ï¼‰

**é¢„æœŸæ•ˆæœ**ï¼š

- è®©é¡¹ç›®åœ¨ GitHub Trending ä¸Šè·å¾—æ›´å¤šå…³æ³¨
- éªŒè¯æŠ€æœ¯æ–¹æ¡ˆå¯è¡Œæ€§
- æ”¶é›†ç”¨æˆ·åé¦ˆ

---

**æ–‡æ¡£ç»“æŸ**
